{% extends "base.html" %}
{% load static %}

{% block navigation %}{% endblock %}
{% block footer %}{% endblock %}

{% block title %}üöÄ Imaginauts World{% endblock %}

{% block extra_css %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Header */
.header {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
    flex-wrap: wrap;
}

.welcome-title {
    font-size: clamp(1.25rem, 5vw, 2rem);
    font-weight: bold;
    color: #667eea;
    flex: 1;
    min-width: 200px;
}

/* User Menu Dropdown */
.user-menu {
    position: relative;
}

.user-menu-toggle {
    background: white;
    border: 2px solid #667eea;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    white-space: nowrap;
}

.user-menu-toggle:hover {
    background: #667eea;
    color: white;
}

#userMenuToggle .toggle-text {
    display: inline;
}

#userMenuToggle .burger-icon {
    display: none;
}

.user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
}

.user-menu-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    min-width: 200px;
    display: none;
    z-index: 1000;
}

.user-menu.active .user-menu-dropdown {
    display: block;
}

.user-menu-dropdown a,
.user-menu-dropdown button {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #333;
    text-decoration: none;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.user-menu-dropdown a:hover,
.user-menu-dropdown button:hover {
    background: #f3f0ff;
}

.user-menu-dropdown a:first-child,
.user-menu-dropdown button:first-child {
    border-radius: 12px 12px 0 0;
}

.user-menu-dropdown a:last-child,
.user-menu-dropdown button:last-child {
    border-radius: 0 0 12px 12px;
    color: #dc2626;
}

.user-menu-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 4px 0;
}

/* Stage Progress */
.stage-progress {
    margin-top: 16px;
}

.stage-label {
    font-size: 16px;
    font-weight: 600;
    color: #764ba2;
    margin-bottom: 12px;
}

.stars-display {
    font-size: 32px;
    letter-spacing: 4px;
    margin-bottom: 12px;
}

.next-milestone {
    font-size: 14px;
    color: #666;
    line-height: 1.6;
}

/* Section Header */
.section-header {
    font-size: 20px;
    font-weight: bold;
    color: white;
    margin-top: 32px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Adventures Grid */
.adventures-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.adventure-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    border: 2px solid transparent;
    min-height: 360px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.adventure-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    border-color: #667eea;
}

.adventure-emoji {
    font-size: 48px;
    margin-bottom: 12px;
}

.adventure-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.3;
}

.adventure-meta {
    font-size: 13px;
    color: #999;
    display: flex;
    gap: 12px;
    margin-top: 12px;
}

.adventure-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.adventure-description {
    font-size: 14px;
    color: #666;
    margin-top: 12px;
    line-height: 1.5;
}

/* Teaser Card */
.teaser-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
    border: 2px dashed #764ba2;
}

.teaser-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.teaser-title {
    font-size: 18px;
    font-weight: 600;
    color: #764ba2;
    margin-bottom: 8px;
}

.teaser-message {
    font-size: 14px;
    color: #666;
    margin-bottom: 16px;
    line-height: 1.6;
}

.teaser-locked-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
}

.locked-item {
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    color: #999;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Coming Soon Card */
.coming-soon-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
}

.coming-soon-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.coming-soon-title {
    font-size: 18px;
    font-weight: 600;
    color: #764ba2;
}

/* Badges Section */
.badges-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.badges-header {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
}

.badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 20px 16px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
}

.badge-emoji {
    font-size: 32px;
    margin-bottom: 8px;
}

.badge-title {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.4;
    word-break: break-word;
    margin: 8px 0;
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.badge-date {
    font-size: 10px;
    opacity: 0.8;
    margin-top: 6px;
}

.no-badges {
    text-align: center;
    padding: 24px;
    color: #999;
    font-size: 14px;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 16px;
    }

    .header {
        padding: 16px;
    }

    .welcome-title {
        font-size: 22px;
        flex: 1;
    }

    .adventures-grid {
        grid-template-columns: 1fr;
    }

    .section-header {
        font-size: 18px;
    }

    .badges-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }
    
    .badge {
        min-height: 160px;
        padding: 16px 12px;
    }
    
    /* Mobile burger menu */
    #userMenuToggle .toggle-text {
        display: none;
    }
    
    #userMenuToggle .user-avatar {
        display: none;
    }
    
    #userMenuToggle .burger-icon {
        display: inline;
    }
    
    #userMenuToggle .dropdown-icon {
        display: none;
    }
    
    #userMenuToggle span {
        display: none;
    }
    
    .user-menu-toggle {
        padding: 8px 12px;
        border-radius: 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- HEADER: Welcome + Stage Progress -->
    <div class="header">
        <div class="header-top">
            <div class="welcome-title">üöÄ Welcome back, {{ child.username }} the Imaginaut!</div>
            
            <!-- User Menu -->
            <div class="user-menu" id="userMenu">
                <button class="user-menu-toggle" id="userMenuToggle">
                    <div class="user-avatar">{{ child.username|first|upper }}</div>
                    <span class="toggle-text">{{ child.username|truncatechars:12 }}</span>
                    <svg class="burger-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                    <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="user-menu-dropdown">
                    {% if request.user.is_staff and not request.session.child_id %}
                    {# Admin Menu #}
                    <a href="/admin/">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        Admin Dashboard
                    </a>
                    <a href="/admin/users/project/add/">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Create Project
                    </a>
                    <a href="/admin/users/childprofile/">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Manage Users
                    </a>
                    <a href="{% url 'users:child_dashboard' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                        </svg>
                        Kids View
                    </a>
                    {% elif child.parent.user == request.user and not request.session.child_id %}
                    {# Parent Menu - viewing their child's dashboard #}
                    <a href="{% url 'users:dashboard' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Parent Dashboard
                    </a>
                    <a href="{% url 'users:dashboard' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        My Children
                    </a>
                    <a href="{% url 'users:growth_map' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        {{ child.username }}'s Progress
                    </a>
                    <a href="#">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/>
                        </svg>
                        Settings
                    </a>
                    {% else %}
                    {# Child Menu - the child themselves #}
                    <a href="{% url 'users:child_dashboard' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                        </svg>
                        My Dashboard
                    </a>
                    <a href="#">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        My Adventures
                    </a>
                    <a href="#">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="7"/>
                            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                        </svg>
                        My Badges
                    </a>
                    <a href="{% url 'users:growth_map' %}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        My Growth Map
                    </a>
                    {% endif %}
                    <div class="user-menu-divider"></div>
                    <form method="post" action="{% url 'users:child_logout' %}" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Stage Progress: Stars Display -->
        <div class="stage-progress">
            <div class="stage-label">Stage {{ current_stage_number }}: {{ stage.get_stage_name }}</div>
            
            <!-- OPTION 1: Stars Display -->
            <div class="stars-display">
                {% for s in all_stages %}
                    {% if s.number <= current_stage_number %}‚≠ê{% else %}‚òÜ{% endif %}
                {% endfor %}
                <span style="font-size: 18px; color: #999;">({{ current_stage_number }}/5)</span>
            </div>

            <!-- Milestone message -->
            <div class="next-milestone">
                {% if current_stage_number < 5 %}
                    Complete more adventures to reach the next stage!
                {% else %}
                    üéâ You've unlocked all stages! Keep creating!
                {% endif %}
            </div>
        </div>
    </div>

    <!-- CONTINUE ADVENTURES -->
    {% if in_progress_projects %}
    <div class="section-header">üß≠ CONTINUE ADVENTURES</div>
    <div class="adventures-grid">
        {% for adventure in in_progress_projects %}
        <a href="{% url 'users:project_detail' adventure.id %}" style="text-decoration: none; color: inherit;">
            <div class="adventure-card" style="border-color: #f59e0b;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="adventure-emoji">{{ adventure.emoji }}</div>
                    <span style="background:#f59e0b; color:white; font-size:12px; padding:6px 10px; border-radius:999px; font-weight:700;">In Progress</span>
                </div>
                <div class="adventure-title">{{ adventure.title }}</div>
                <div class="adventure-description">{{ adventure.description|truncatewords:15 }}</div>
                <div style="margin-top: 10px;">
                    <div style="height: 8px; background:#e5e7eb; border-radius:999px; overflow:hidden;">
                        <div style="width: 60%; height:100%; background: linear-gradient(90deg,#f59e0b,#d97706);"></div>
                    </div>
                    <div style="font-size:12px; color:#92400e; margin-top:6px;">Progress: in progress</div>
                </div>
                <div class="adventure-meta">
                    <span>‚è±Ô∏è {{ adventure.estimated_time }}min</span>
                    <span>‚ñ∂ Continue</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- NEW ADVENTURES -->
    {% if new_projects %}
    <div class="section-header">‚ú® NEW ADVENTURES</div>
    <div class="adventures-grid">
        {% for adventure in new_projects %}
        <a href="{% url 'users:project_detail' adventure.id %}" style="text-decoration: none; color: inherit;">
            <div class="adventure-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="adventure-emoji">{{ adventure.emoji }}</div>
                    <span style="background:#667eea; color:white; font-size:12px; padding:6px 10px; border-radius:999px; font-weight:700;">New</span>
                </div>
                <div class="adventure-title">{{ adventure.title }}</div>
                <div class="adventure-description">{{ adventure.description|truncatewords:15 }}</div>
                <div style="margin-top: 10px;">
                    <div style="height: 8px; background:#e5e7eb; border-radius:999px; overflow:hidden;">
                        <div style="width: 0%; height:100%; background: linear-gradient(90deg,#667eea,#764ba2);"></div>
                    </div>
                    <div style="font-size:12px; color:#6b7280; margin-top:6px;">Progress: not started</div>
                </div>
                <div class="adventure-meta">
                    <span>‚è±Ô∏è {{ adventure.estimated_time }}min</span>
                    <span>
                        {% if adventure.difficulty == 1 %}üü¢ Easy
                        {% elif adventure.difficulty == 2 %}üü° Medium
                        {% else %}üî¥ Hard
                        {% endif %}
                    </span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    {% if not in_progress_projects and not new_projects %}
    <div class="section-header">‚ö° YOUR ADVENTURES</div>
    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 32px; text-align: center; border: 2px solid #fbbf24;">
        <div style="font-size: 48px; margin-bottom: 16px;">üéâ</div>
        <h3 style="margin: 0 0 12px 0; color: #92400e; font-size: 1.5rem;">Amazing Progress!</h3>
        <p style="color: #78350f; margin: 0 0 20px 0; font-size: 1.1rem;">
            You've completed all available adventures at your current level!
        </p>
        <p style="color: #a16207; font-size: 0.95rem; max-width: 400px; margin: 0 auto;">
            Complete a few more adventures with reflections to unlock the next stage and discover exciting new projects!
        </p>
    </div>
    {% endif %}

    <!-- NEXT LEVEL TEASER -->
    {% if locked_teaser %}
    <div class="section-header">üîí NEXT LEVEL UNLOCKS</div>
    <div class="teaser-card">
        <div class="teaser-icon">üîì</div>
        <div class="teaser-title">Almost there!</div>
        <div class="teaser-message">
            {% if remaining_projects_for_next_stage > 0 or remaining_reflections_for_next_stage > 0 %}
                Complete {{ remaining_projects_for_next_stage }} more adventure{{ remaining_projects_for_next_stage|pluralize }}{% if remaining_reflections_for_next_stage > 0 %} and add {{ remaining_reflections_for_next_stage }} reflection{{ remaining_reflections_for_next_stage|pluralize }}{% endif %} to unlock {{ next_stage_name }} and explore these:
            {% else %}
                You're ready to unlock {{ next_stage_name }}! Explore these now:
            {% endif %}
        </div>
        <div class="teaser-locked-items">
            {% for project in locked_teaser %}
            <div class="locked-item">
                <span>üîí</span>
                <span>{{ project.emoji }} {{ project.title }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- COMING SOON -->
    {% if coming_soon %}
    <div class="section-header">üîÆ COMING SOON</div>
    <div class="coming-soon-card">
        {% for project in coming_soon %}
        <div class="coming-soon-icon">{{ project.emoji }}</div>
        <div class="coming-soon-title">{{ project.title }}</div>
        <p style="margin-top: 8px; font-size: 13px; color: #999;">Stay tuned for new adventures!</p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- COMPLETED ADVENTURES -->
    <div class="section-header">‚úÖ COMPLETED ADVENTURES</div>
    <div class="badges-section">
        {% if completed_projects %}
        <details>
            <summary style="cursor:pointer; font-weight:700; color:#333; margin-bottom:16px;">Show completed ({{ completed_projects|length }})</summary>
            <div class="badges-grid">
                {% for progress in completed_projects %}
                <a href="{% url 'users:project_detail' progress.project.id %}" style="text-decoration:none; color:inherit;">
                    <div class="badge">
                        <div class="badge-emoji">‚úÖ</div>
                        <div class="badge-title">{{ progress.project.title|truncatewords:4 }}</div>
                        <div style="font-size:11px; margin-top:8px; display:flex; flex-direction:column; gap:4px;">
                            {% if progress.reflection_text %}
                                <span style="background:#dcfce7; color:#166534; padding:4px 8px; border-radius:999px; font-weight:500;">üí≠ Reflected</span>
                            {% else %}
                                <span style="background:#fef3c7; color:#92400e; padding:4px 8px; border-radius:999px; font-weight:500;">üí≠ Reflect</span>
                            {% endif %}
                            {% if progress.rating %}
                                <span style="background:#dbeafe; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:500;">‚≠ê Rated</span>
                            {% else %}
                                <span style="background:#fee2e2; color:#991b1b; padding:4px 8px; border-radius:999px; font-weight:500;">‚≠ê Rate</span>
                            {% endif %}
                        </div>
                        <div class="badge-date">
                            {% if progress.completed_at %}
                                {{ progress.completed_at|timesince }} ago
                            {% else %}
                                Recently
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </details>
        {% else %}
        <div class="no-badges">
            Complete your first adventure to fill this section! üéØ
        </div>
        {% endif %}
    </div>

</div>

<script>
// User menu dropdown toggle
(function() {
    const userMenu = document.getElementById('userMenu');
    const userMenuToggle = document.getElementById('userMenuToggle');
    
    if (userMenu && userMenuToggle) {
        userMenuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('active');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });
    }
})();
</script>
{% endblock %}
